module HML.FileIO.CSVReader
(convertToBinary) where
import HML.Aux
import Conduit ((.|), ConduitM, mapC, sourceFileBS, takeC)
import Data.ByteString (concat)
import Data.CSV.Conduit (defCSVSettings, intoCSV)
import Data.Void (Void)
import HML.FileIO.FileReader (FileReader)
import HML.FileIO.MatrixHeader (MatrixHeader(..))
import HML.FileIO.MatrixSink (matrixDoubleSink)
import HML.FileIO.MatrixSource (poolMatrixDouble)
import HML.Types.PosInt (getPosInt)
import Prelude hiding (concat)

convertToBinary :: FilePath
                -> FilePath
                -> MatrixHeader
                -> Int
                -> ConduitM ()
                            Void
                            FileReader
                            ()
convertToBinary inPath outPath header step = 
  let nCols = cols header
      nRows = rows header
      c = getPosInt nCols
      sink = matrixDoubleSink header outPath
  in sourceFileBS inPath
  .| takeC (step*c)
  .| intoCSV defCSVSettings
  .| prointConduit "before concat"
  .| mapC concat
  .| printConduit "before pool"
  .| poolMatrixDouble nRows nCols
  .| printConduit "after pool"
  .| sink
